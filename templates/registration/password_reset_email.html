"""
Test de l'email de rÃ©initialisation de mot de passe
Ã€ placer Ã  la RACINE du projet

Usage: python test_password_reset.py
"""
import os
import django

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'agritech.settings')
django.setup()

from django.contrib.auth.models import User
from django.contrib.auth.forms import PasswordResetForm

print("=" * 70)
print("ğŸ§ª TEST EMAIL DE RÃ‰INITIALISATION DE MOT DE PASSE")
print("=" * 70)

# VÃ©rifier qu'il y a au moins un utilisateur
users = User.objects.all()
if not users.exists():
    print("\nâŒ Aucun utilisateur trouvÃ© dans la base de donnÃ©es")
    print("   CrÃ©ez d'abord un utilisateur avec: python manage.py createsuperuser")
    exit(1)

print(f"\nğŸ“‹ Utilisateurs disponibles:")
for i, user in enumerate(users, 1):
    email = user.email or "âŒ Pas d'email"
    print(f"   {i}. {user.username} - {email}")

# Demander quel utilisateur tester
try:
    choix = input("\nEntrez le numÃ©ro de l'utilisateur Ã  tester (ou appuyez sur EntrÃ©e pour le premier): ")
    if choix.strip():
        user = list(users)[int(choix) - 1]
    else:
        user = users.first()
except (ValueError, IndexError):
    print("âŒ Choix invalide, utilisation du premier utilisateur")
    user = users.first()

if not user.email:
    print(f"\nâš ï¸ L'utilisateur '{user.username}' n'a pas d'email configurÃ©")
    email = input("Entrez une adresse email pour le test: ")
    user.email = email
    user.save()

print(f"\nğŸ“§ Test avec l'utilisateur: {user.username}")
print(f"   Email: {user.email}")

# Envoyer l'email de rÃ©initialisation
print(f"\nğŸš€ Envoi de l'email de rÃ©initialisation...")

form = PasswordResetForm({'email': user.email})
if form.is_valid():
    form.save(
        request=None,
        use_https=False,
        email_template_name='registration/password_reset_email.html',
        subject_template_name='registration/password_reset_subject.txt',
        from_email=None,
    )
    print(f"\nâœ… Email envoyÃ© Ã  {user.email}")
    print(f"\nğŸ“¬ VÃ©rifiez votre boÃ®te mail (et les spams)")
    print(f"\nğŸ’¡ Si le bouton ne s'affiche pas bien:")
    print(f"   - VÃ©rifiez que le fichier password_reset_email.html est bien Ã  jour")
    print(f"   - Rechargez Django: python manage.py runserver")
else:
    print(f"\nâŒ Erreur: {form.errors}")

print("\n" + "=" * 70)